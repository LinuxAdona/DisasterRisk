{% extends 'base.html' %}

{% block title %}Evacuee Management - Volunteer Dashboard{% endblock %}

{% block content %}
<div class="container">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1>Evacuee Management</h1>
        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addEvacueeModal">
            <i class="fas fa-plus me-1"></i> Register Evacuee
        </button>
    </div>
    
    <!-- Search and Filter -->
    <div class="card mb-4">
        <div class="card-body">
            <form action="{{ url_for('volunteer.evacuees') }}" method="GET" class="row g-3">
                <div class="col-md-4">
                    <div class="input-group">
                        <input type="text" class="form-control" placeholder="Search evacuees..." name="query" value="{{ request.args.get('query', '') }}">
                        <button class="btn btn-outline-secondary" type="submit">
                            <i class="fas fa-search"></i>
                        </button>
                    </div>
                </div>
                
                <div class="col-md-3">
                    <select class="form-select" name="status">
                        <option value="">All Statuses</option>
                        <option value="present" {% if request.args.get('status') == 'present' %}selected{% endif %}>Present</option>
                        <option value="relocated" {% if request.args.get('status') == 'relocated' %}selected{% endif %}>Relocated</option>
                        <option value="missing" {% if request.args.get('status') == 'missing' %}selected{% endif %}>Missing</option>
                        <option value="deceased" {% if request.args.get('status') == 'deceased' %}selected{% endif %}>Deceased</option>
                    </select>
                </div>
                
                <div class="col-md-3">
                    <select class="form-select" name="center">
                        <option value="">All Centers</option>
                        {% for center in centers if centers is defined %}
                            <option value="{{ center.id }}" {% if request.args.get('center')|int == center.id %}selected{% endif %}>{{ center.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                
                <div class="col-md-2">
                    <button type="submit" class="btn btn-primary w-100">Filter</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Evacuees Table -->
    <div class="card">
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-hover datatable">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Age</th>
                            <th>Gender</th>
                            <th>Family</th>
                            <th>Evacuation Center</th>
                            <th>Status</th>
                            <th>Special Needs</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for evacuee in evacuees %}
                        <tr>
                            <td>{{ evacuee.full_name }}</td>
                            <td>{{ evacuee.age if evacuee.age else 'N/A' }}</td>
                            <td>{{ evacuee.gender|capitalize if evacuee.gender else 'N/A' }}</td>
                            <td>{{ evacuee.family.family_name if evacuee.family else 'N/A' }}</td>
                            <td>{{ evacuee.evacuation_center.name if evacuee.evacuation_center else 'Not assigned' }}</td>
                            <td>
                                <form action="{{ url_for('volunteer.update_evacuee_status', evacuee_id=evacuee.id) }}" method="POST" class="status-update-form">
                                    <select class="form-select form-select-sm" name="status" data-original-value="{{ evacuee.status }}">
                                        <option value="present" {% if evacuee.status == 'present' %}selected{% endif %}>Present</option>
                                        <option value="relocated" {% if evacuee.status == 'relocated' %}selected{% endif %}>Relocated</option>
                                        <option value="missing" {% if evacuee.status == 'missing' %}selected{% endif %}>Missing</option>
                                        <option value="deceased" {% if evacuee.status == 'deceased' %}selected{% endif %}>Deceased</option>
                                    </select>
                                </form>
                            </td>
                            <td>{{ evacuee.special_needs if evacuee.special_needs else 'None' }}</td>
                            <td>
                                <button class="btn btn-sm btn-outline-primary" data-bs-toggle="modal" data-bs-target="#editEvacueeModal-{{ evacuee.id }}">
                                    <i class="fas fa-edit"></i>
                                </button>
                            </td>
                        </tr>
                        {% else %}
                        <tr>
                            <td colspan="8" class="text-center">No evacuees found.</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    
    <!-- Add Evacuee Modal -->
    <div class="modal fade" id="addEvacueeModal" tabindex="-1" aria-labelledby="addEvacueeModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="addEvacueeModalLabel">Register Evacuee</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form action="{{ url_for('volunteer.add_evacuee') }}" method="POST" class="needs-validation" novalidate>
                    <div class="modal-body">
                        {{ form.hidden_tag() }}
                        
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="first_name" class="form-label">First Name</label>
                                {{ form.first_name(class="form-control", id="first_name", placeholder="Enter first name") }}
                                <div class="invalid-feedback">
                                    Please provide a first name.
                                </div>
                            </div>
                            
                            <div class="col-md-6 mb-3">
                                <label for="last_name" class="form-label">Last Name</label>
                                {{ form.last_name(class="form-control", id="last_name", placeholder="Enter last name") }}
                                <div class="invalid-feedback">
                                    Please provide a last name.
                                </div>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="date_of_birth" class="form-label">Date of Birth</label>
                                {{ form.date_of_birth(class="form-control", id="date_of_birth", type="date") }}
                                <div class="invalid-feedback">
                                    Please provide a valid date of birth.
                                </div>
                            </div>
                            
                            <div class="col-md-6 mb-3">
                                <label for="gender" class="form-label">Gender</label>
                                {{ form.gender(class="form-select", id="gender") }}
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="evacuation_center_id" class="form-label">Evacuation Center</label>
                            {{ form.evacuation_center_id(class="form-select", id="evacuation_center_id") }}
                            <div class="invalid-feedback">
                                Please select an evacuation center.
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="family_id" class="form-label">Family</label>
                            {{ form.family_id(class="form-select", id="family_id") }}
                        </div>
                        
                        <div class="mb-3">
                            <label for="status" class="form-label">Status</label>
                            {{ form.status(class="form-select", id="status") }}
                        </div>
                        
                        <div class="mb-3">
                            <label for="special_needs" class="form-label">Special Needs</label>
                            {{ form.special_needs(class="form-control", id="special_needs", placeholder="Enter any special needs or medical conditions") }}
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        {{ form.submit(class="btn btn-primary") }}
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <!-- Edit Evacuee Modals -->
    {% for evacuee in evacuees %}
    <div class="modal fade" id="editEvacueeModal-{{ evacuee.id }}" tabindex="-1" aria-labelledby="editEvacueeModalLabel-{{ evacuee.id }}" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="editEvacueeModalLabel-{{ evacuee.id }}">Edit Evacuee</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form action="{{ url_for('volunteer.edit_evacuee', evacuee_id=evacuee.id) }}" method="POST" class="needs-validation" novalidate>
                    <div class="modal-body">
                        {{ form.hidden_tag() }}
                        
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="first_name-{{ evacuee.id }}" class="form-label">First Name</label>
                                <input type="text" class="form-control" id="first_name-{{ evacuee.id }}" name="first_name" value="{{ evacuee.first_name }}" required>
                                <div class="invalid-feedback">
                                    Please provide a first name.
                                </div>
                            </div>
                            
                            <div class="col-md-6 mb-3">
                                <label for="last_name-{{ evacuee.id }}" class="form-label">Last Name</label>
                                <input type="text" class="form-control" id="last_name-{{ evacuee.id }}" name="last_name" value="{{ evacuee.last_name }}" required>
                                <div class="invalid-feedback">
                                    Please provide a last name.
                                </div>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="date_of_birth-{{ evacuee.id }}" class="form-label">Date of Birth</label>
                                <input type="date" class="form-control" id="date_of_birth-{{ evacuee.id }}" name="date_of_birth" value="{{ evacuee.date_of_birth }}">
                                <div class="invalid-feedback">
                                    Please provide a valid date of birth.
                                </div>
                            </div>
                            
                            <div class="col-md-6 mb-3">
                                <label for="gender-{{ evacuee.id }}" class="form-label">Gender</label>
                                <select class="form-select" id="gender-{{ evacuee.id }}" name="gender">
                                    <option value="male" {% if evacuee.gender == 'male' %}selected{% endif %}>Male</option>
                                    <option value="female" {% if evacuee.gender == 'female' %}selected{% endif %}>Female</option>
                                    <option value="other" {% if evacuee.gender == 'other' %}selected{% endif %}>Other</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="evacuation_center_id-{{ evacuee.id }}" class="form-label">Evacuation Center</label>
                            <select class="form-select" id="evacuation_center_id-{{ evacuee.id }}" name="evacuation_center_id" required>
                                {% for center in centers if centers is defined %}
                                    <option value="{{ center.id }}" {% if evacuee.evacuation_center_id == center.id %}selected{% endif %}>
                                        {{ center.name }}
                                    </option>
                                {% endfor %}
                            </select>
                            <div class="invalid-feedback">
                                Please select an evacuation center.
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="family_id-{{ evacuee.id }}" class="form-label">Family</label>
                            <select class="form-select" id="family_id-{{ evacuee.id }}" name="family_id">
                                <option value="0">None</option>
                                {% for family in families if families is defined %}
                                    <option value="{{ family.id }}" {% if evacuee.family_id == family.id %}selected{% endif %}>
                                        {{ family.family_name }}
                                    </option>
                                {% endfor %}
                            </select>
                        </div>
                        
                        <div class="mb-3">
                            <label for="status-{{ evacuee.id }}" class="form-label">Status</label>
                            <select class="form-select" id="status-{{ evacuee.id }}" name="status">
                                <option value="present" {% if evacuee.status == 'present' %}selected{% endif %}>Present</option>
                                <option value="relocated" {% if evacuee.status == 'relocated' %}selected{% endif %}>Relocated</option>
                                <option value="missing" {% if evacuee.status == 'missing' %}selected{% endif %}>Missing</option>
                                <option value="deceased" {% if evacuee.status == 'deceased' %}selected{% endif %}>Deceased</option>
                            </select>
                        </div>
                        
                        <div class="mb-3">
                            <label for="special_needs-{{ evacuee.id }}" class="form-label">Special Needs</label>
                            <textarea class="form-control" id="special_needs-{{ evacuee.id }}" name="special_needs" rows="3">{{ evacuee.special_needs }}</textarea>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary">Save Changes</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    {% endfor %}
</div>
{% endblock %}
